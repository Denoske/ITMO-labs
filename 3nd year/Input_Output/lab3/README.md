# Лабораторная работа 3

**Название:** "Разработка драйверов сетевых устройств"

**Цель работы:**

> Получить знания и навыки разработки драйверов сетевых интерфейсов для
> операционной системы Linux.

## Описание функциональности драйвера

Функциональность дравера соответсвует заданию варианта:

> Пакеты протокола UDP, адресуемые на конкретный порт. Вывести порт отправителя
> и получателя. Номер порта определяется исполнителями.
>
> Состояние разбора пакетов необходимо выводить в кольцевой буфер ядра

Порт, по которому происходит фильтрация, указывается как значение макроса в файле.
При желании можно вынести это значение в статическое значение, которое
заполняется как параметр загрузки модуля.

## Инструкция по сборке

Для сборки модуля ядра из исходного кода нужно в директории `lab-3/driver/`
выполнить цель по умолчанию для `make`, при этом требуется права
суперпользователя:

```shell 
sudo make 
```

После успешной компиляции в той же директории должен появиться файл
`virt_net_if.ko`.


## Инструкция пользователя

Для загрузки модуля нужно выполнить соответствующую команду с правами
администратора:

```shell
sudo insmod virt_net_if.ko
```

Проверить загрузку модуля можно с помощью команд:

```shell
lsmod | grep virt_net_if
```

Для выгрузки модуля нужно выполнить соответствующую команду с правами
администратора:

```shell
sudo rmmod virt_net_if
```

## Примеры использования

Для проверки работоспособности драйвера можно отправить из отдельной консоли
сообщение по протоколу UDP, например таким образом:

```shell
echo "kek" | ns -u 192.168.1.86 20
```


Результат получения пакета можно наблюдать в `dmesg` и в `ifconfig` ("RX packets"):

```text
root@zc4:~# dmesg | grep -5 kek
[10030.784287] IPv6: ADDRCONF(NETDEV_UP): vni0: link is not ready
[10030.785573] vni0: device opened
[10040.308534] Captured UDP datagram, saddr: 192.168.1.48:52163
[10040.308545] daddr: 192.168.1.86:20
[10040.308550] Data length: 14. Data:
[10040.308554] ==== kek ====
[10096.152435] Captured UDP datagram, saddr: 192.168.1.48:52185
[10096.152461] daddr: 192.168.1.86:20
[10096.152470] Data length: 14. Data:
[10096.152477] ==== kek ====
[10106.943711] Captured UDP datagram, saddr: 192.168.1.48:52169
[10106.943738] daddr: 192.168.1.86:20
[10106.943747] Data length: 14. Data:
[10106.943755] ==== kek ====
```

```text
root@zc4:~# ifconfig | tail -9
vni0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.168.1.86  netmask 255.255.255.0  broadcast 192.168.1.255
        inet6 fe80::213a:6ebc:17ae:1c57  prefixlen 64  scopeid 0x20<link>
        ether 72:b7:90:7b:66:55  txqueuelen 1000  (Ethernet)
        RX packets 3  bytes 138 (138.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```
